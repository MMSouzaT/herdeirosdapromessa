<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criador de E-books B√≠blicos - Ferramenta Interna</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Tela de Login */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #loginScreen.hidden {
            display: none;
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .login-box input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .login-box input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-box button:hover {
            transform: translateY(-2px);
        }

        .login-error {
            color: #dc3545;
            margin-top: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        #mainApp {
            display: none;
        }

        #mainApp.show {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            position: relative;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 4px;
            background: #667eea;
        }

        .tab-content {
            display: none;
            padding: 40px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #e0e0e0;
        }

        .result-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .canvas-container {
            text-align: center;
            margin: 20px 0;
        }

        #imageCanvas {
            border: 2px solid #ddd;
            max-width: 100%;
            cursor: crosshair;
            border-radius: 8px;
        }

        .pages-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .page-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .page-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .page-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .page-item .page-number {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .page-item .page-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .page-item .btn-small {
            flex: 1;
            padding: 8px;
            font-size: 0.85em;
        }

        .api-config {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .api-config h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 968px) {
            .tools-grid {
                grid-template-columns: 1fr;
            }
        }

        .text-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-group input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .image-preview {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }

        .quick-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .quick-prompt-btn {
            padding: 10px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .quick-prompt-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen">
        <div class="login-box">
            <h1>üîí Acesso Restrito</h1>
            <p>Criador de E-books B√≠blicos</p>
            <input type="password" id="passwordInput" placeholder="Digite a senha" onkeypress="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()">Entrar</button>
            <div class="login-error" id="loginError">‚ùå Senha incorreta!</div>
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="mainApp">
    <div class="container">
        <div class="header">
            <h1>üé® Criador de E-books B√≠blicos</h1>
            <p>Ferramenta completa para cria√ß√£o de e-books infantis</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">üöÄ Criar E-book</button>
            <button class="tab" onclick="switchTab(1)">‚öôÔ∏è Configura√ß√£o</button>
            <button class="tab" onclick="switchTab(2)">üìö E-books Gerados</button>
            <button class="tab" onclick="switchTab(3)">‚úèÔ∏è Edi√ß√£o Manual</button>
        </div>

        <!-- Tab 0: Criar E-book Automaticamente -->
        <div class="tab-content active">
            <div class="alert alert-success" style="text-align: center; padding: 30px;">
                <h2 style="color: #155724; margin-bottom: 15px;">üéâ Criador Autom√°tico de E-books</h2>
                <p style="font-size: 1.1em;">Insira apenas sua ideia e deixe a IA fazer todo o trabalho!</p>
            </div>

            <div class="section">
                <h2>üìù Sua Ideia</h2>
                
                <div class="form-group">
                    <label for="themeInput">Tema ou Hist√≥ria B√≠blica:</label>
                    <input type="text" id="themeInput" placeholder="Ex: O Bom Samaritano, No√© e a Arca, Daniel na Cova dos Le√µes...">
                </div>

                <div class="form-group">
                    <label for="ageRange">Faixa Et√°ria:</label>
                    <select id="ageRange">
                        <option value="2-4">2-4 anos</option>
                        <option value="4-6">4-6 anos</option>
                        <option value="6-8">6-8 anos</option>
                        <option value="8-10">8-10 anos</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="numPages">N√∫mero de P√°ginas:</label>
                    <input type="number" id="numPages" value="10" min="5" max="20">
                </div>

                <div class="form-group">
                    <label for="stylePreset">Estilo de Ilustra√ß√£o:</label>
                    <select id="stylePreset">
                        <option value="cartoon colorido e amig√°vel">Cartoon Colorido</option>
                        <option value="aquarela suave e delicada">Aquarela Suave</option>
                        <option value="ilustra√ß√£o digital vibrante">Digital Vibrante</option>
                        <option value="estilo storybook cl√°ssico">Storybook Cl√°ssico</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoCompile" checked>
                        Compilar automaticamente em PDF ao finalizar
                    </label>
                </div>

                <button class="btn" onclick="createCompleteEbook()" style="width: 100%; padding: 20px; font-size: 1.3em;">
                    üöÄ CRIAR E-BOOK COMPLETO AUTOMATICAMENTE
                </button>

                <div class="loading" id="mainLoading">
                    <div class="spinner"></div>
                    <p id="loadingMessage">Iniciando processo...</p>
                    <div style="margin-top: 20px; background: white; padding: 15px; border-radius: 8px;">
                        <div id="progressLog" style="max-height: 300px; overflow-y: auto; text-align: left;"></div>
                    </div>
                </div>

                <div id="mainResult"></div>
            </div>
        </div>

        <!-- Tab 1: Configura√ß√£o -->
        <div class="tab-content">
            <div class="api-config">
                <h3>‚ö†Ô∏è Configura√ß√£o de APIs</h3>
                <p style="margin-bottom: 15px;">Configure suas chaves de API para usar os recursos de IA. Suas chaves s√£o armazenadas apenas localmente no navegador.</p>
            </div>

            <div class="section">
                <h2>üîë OpenAI API (GPT + DALL-E)</h2>
                <div class="form-group">
                    <label for="openaiKey">Chave da API OpenAI:</label>
                    <input type="password" id="openaiKey" placeholder="sk-...">
                    <small style="display: block; margin-top: 5px; color: #666;">
                        Obtenha em: <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a>
                    </small>
                </div>
                <div class="form-group">
                    <label for="gptModel">Modelo GPT:</label>
                    <select id="gptModel">
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Recomendado - Mais Barato)</option>
                        <option value="gpt-4">GPT-4 (Requer acesso especial)</option>
                        <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                    </select>
                    <small style="display: block; margin-top: 5px; color: #666;">
                        Use GPT-3.5 se n√£o tiver acesso ao GPT-4
                    </small>
                </div>
                <button class="btn" onclick="saveApiKeys()">üíæ Salvar Configura√ß√µes</button>
            </div>

            <div class="alert alert-info">
                <strong>üí° Dica:</strong> Configure sua API Key antes de criar e-books!
            </div>
        </div>

        <!-- Tab 2: E-books Gerados -->
        <div class="tab-content">
            <div class="section">
                <h2>üìö E-books Criados</h2>
                
                <div id="ebooksList" class="pages-list">
                    <div class="alert alert-warning" style="grid-column: 1/-1;">
                        Nenhum e-book criado ainda. V√° para a primeira aba e crie seu primeiro e-book!
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Edi√ß√£o Manual -->
        <div class="tab-content">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Modo Avan√ßado:</strong> Use esta aba para criar e editar p√°ginas manualmente se precisar de mais controle.
            </div>

            <div class="section">
                <h2>‚úèÔ∏è Editor Canvas - Adicionar Texto na Imagem</h2>
                
                <div class="form-group">
                    <label for="canvasImage">Carregar Imagem para Editar:</label>
                    <input type="file" id="canvasImage" accept="image/*" onchange="loadImageToCanvas(event)">
                </div>

                <div class="text-controls">
                    <div class="form-group">
                        <label for="canvasText">Texto:</label>
                        <textarea id="canvasText" placeholder="Digite o texto aqui"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="fontSize">Tamanho da Fonte:</label>
                        <input type="number" id="fontSize" value="40" min="10" max="200">
                    </div>

                    <div class="form-group">
                        <label for="fontFamily">Fonte:</label>
                        <select id="fontFamily">
                            <option value="Arial">Arial</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Impact">Impact</option>
                        </select>
                    </div>

                    <div class="form-group color-picker-group">
                        <label for="textColor">Cor do Texto:</label>
                        <input type="color" id="textColor" value="#ffffff">
                    </div>

                    <div class="form-group color-picker-group">
                        <label for="strokeColor">Cor do Contorno:</label>
                        <input type="color" id="strokeColor" value="#000000">
                    </div>

                    <div class="form-group">
                        <label for="strokeWidth">Espessura do Contorno:</label>
                        <input type="number" id="strokeWidth" value="3" min="0" max="20">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin: 20px 0;">
                    <button class="btn" onclick="addTextToCanvas()">‚ûï Adicionar Texto (Clique na Posi√ß√£o)</button>
                    <button class="btn btn-secondary" onclick="clearCanvas()">üîÑ Limpar Canvas</button>
                </div>

                <div class="canvas-container">
                    <canvas id="imageCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Senha de acesso
        const SENHA_CORRETA = 'herdeiros2026'; // Altere aqui para sua senha

        function checkPassword() {
            const senha = document.getElementById('passwordInput').value;
            
            if (senha === SENHA_CORRETA) {
                // Salvar sess√£o
                sessionStorage.setItem('authenticated', 'true');
                // Mostrar aplica√ß√£o
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('show');
            } else {
                // Mostrar erro
                document.getElementById('loginError').classList.add('show');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
                
                // Esconder erro ap√≥s 3 segundos
                setTimeout(() => {
                    document.getElementById('loginError').classList.remove('show');
                }, 3000);
            }
        }

        // Verificar se j√° est√° autenticado
        window.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('authenticated') === 'true') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.add('show');
            }
        });

        // Estado global
        let generatedEbooks = [];
        let canvas, ctx;
        let currentImage = null;
        let isTextMode = false;
        let currentTextSettings = {};

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar modelo padr√£o se n√£o existir
            if (!localStorage.getItem('gpt_model')) {
                localStorage.setItem('gpt_model', 'gpt-3.5-turbo');
            }
            
            loadApiKeys();
            loadEbooks();
            initCanvas();
        });

        // Gerenciamento de Tabs
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            tabs[index].classList.add('active');
            contents[index].classList.add('active');

            if (index === 2) {
                displayEbooks();
            }
        }

        // Salvar/Carregar API Keys
        function saveApiKeys() {
            const openaiKey = document.getElementById('openaiKey').value;
            const gptModel = document.getElementById('gptModel').value;
            localStorage.setItem('openai_key', openaiKey);
            localStorage.setItem('gpt_model', gptModel);
            alert('‚úÖ Configura√ß√µes salvas com sucesso!');
        }

        function loadApiKeys() {
            const openaiKey = localStorage.getItem('openai_key');
            const gptModel = localStorage.getItem('gpt_model') || 'gpt-3.5-turbo';
            if (openaiKey) {
                document.getElementById('openaiKey').value = openaiKey;
            }
            document.getElementById('gptModel').value = gptModel;
        }

        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('progressLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚è≥';
            logDiv.innerHTML += `<div style="padding: 5px; color: ${type === 'error' ? '#dc3545' : '#333'};">${icon} [${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Fun√ß√£o Principal - Criar E-book Completo
        async function createCompleteEbook() {
            const theme = document.getElementById('themeInput').value;
            const ageRange = document.getElementById('ageRange').value;
            const numPages = document.getElementById('numPages').value;
            const stylePreset = document.getElementById('stylePreset').value;
            const autoCompile = document.getElementById('autoCompile').checked;
            const apiKey = localStorage.getItem('openai_key');

            if (!theme) {
                alert('‚ö†Ô∏è Por favor, insira um tema!');
                return;
            }

            if (!apiKey) {
                alert('‚ö†Ô∏è Configure sua API Key primeiro na aba de Configura√ß√£o!');
                switchTab(1);
                return;
            }

            // Resetar UI
            document.getElementById('mainLoading').classList.add('active');
            document.getElementById('mainResult').innerHTML = '';
            document.getElementById('progressLog').innerHTML = '';
            document.getElementById('loadingMessage').textContent = 'Iniciando processo...';

            try {
                // Etapa 1: Gerar estrutura com GPT
                addLog('Gerando estrutura do e-book com GPT-4...', 'info');
                document.getElementById('loadingMessage').textContent = 'Criando estrutura e textos...';
                
                const structure = await generateEbookStructure(theme, ageRange, numPages, apiKey);
                addLog(`Estrutura criada: "${structure.titulo}" com ${structure.paginas.length} p√°ginas`, 'success');

                // Etapa 2: Gerar todas as imagens
                document.getElementById('loadingMessage').textContent = 'Gerando ilustra√ß√µes com DALL-E...';
                addLog('Iniciando gera√ß√£o de ilustra√ß√µes...', 'info');
                
                const pages = [];
                for (let i = 0; i < structure.paginas.length; i++) {
                    const pagina = structure.paginas[i];
                    addLog(`Gerando imagem ${i + 1}/${structure.paginas.length}: ${pagina.ilustracao.substring(0, 50)}...`, 'info');
                    
                    try {
                        const imageUrl = await generateImageFromPrompt(
                            pagina.ilustracao + ', ' + stylePreset + ', children\'s book illustration, biblical theme',
                            apiKey
                        );
                        
                        // Etapa 3: Adicionar texto na imagem
                        addLog(`Adicionando texto na imagem ${i + 1}...`, 'info');
                        const imageWithText = await addTextToImage(imageUrl, pagina.texto);
                        
                        pages.push({
                            number: i + 1,
                            image: imageWithText,
                            text: pagina.texto
                        });
                        
                        addLog(`P√°gina ${i + 1} completa!`, 'success');
                    } catch (error) {
                        addLog(`Erro na p√°gina ${i + 1}: ${error.message}`, 'error');
                        throw error;
                    }
                }

                // Etapa 4: Compilar PDF
                if (autoCompile) {
                    document.getElementById('loadingMessage').textContent = 'Compilando PDF...';
                    addLog('Compilando e-book em PDF...', 'info');
                    
                    const pdfBlob = await compilePDFFromPages(pages, structure.titulo, 'Herdeiros da Promessa');
                    addLog('PDF compilado com sucesso!', 'success');
                    
                    // Salvar e-book
                    const ebook = {
                        id: Date.now(),
                        title: structure.titulo,
                        theme: theme,
                        pages: pages.length,
                        createdAt: new Date().toISOString(),
                        pdfBlob: pdfBlob
                    };
                    
                    generatedEbooks.push(ebook);
                    saveEbooks();
                    
                    // Download autom√°tico
                    downloadPDF(pdfBlob, structure.titulo);
                }

                // Sucesso!
                document.getElementById('loadingMessage').textContent = 'Conclu√≠do!';
                addLog('üéâ E-book criado com sucesso!', 'success');
                
                showSuccessMessage(structure.titulo, pages.length);

            } catch (error) {
                addLog('Erro fatal: ' + error.message, 'error');
                alert('‚ùå Erro ao criar e-book: ' + error.message);
                console.error(error);
            } finally {
                setTimeout(() => {
                    document.getElementById('mainLoading').classList.remove('active');
                }, 2000);
            }
        }

        // Gerar estrutura do e-book com GPT
        async function generateEbookStructure(theme, ageRange, numPages, apiKey) {
            const gptModel = localStorage.getItem('gpt_model') || 'gpt-3.5-turbo';
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: gptModel,
                    messages: [{
                        role: 'user',
                        content: `Crie uma estrutura completa para um e-book infantil b√≠blico sobre "${theme}" para crian√ßas de ${ageRange} anos com ${numPages} p√°ginas.

Para cada p√°gina, forne√ßa:
1. N√∫mero da p√°gina
2. Texto CURTO (m√°ximo 2 linhas) adequado para a idade, com linguagem simples e envolvente
3. Descri√ß√£o DETALHADA da ilustra√ß√£o para gera√ß√£o com IA (inclua detalhes sobre personagens, cen√°rio, cores, atmosfera)

IMPORTANTE: 
- Textos devem ser muito curtos e simples
- Descri√ß√µes de ilustra√ß√£o devem ser ricas em detalhes visuais
- Mantenha o tema b√≠blico de forma apropriada para crian√ßas

Responda APENAS com JSON v√°lido neste formato:
{
  "titulo": "t√≠tulo do ebook",
  "sinopse": "breve descri√ß√£o",
  "paginas": [
    {
      "numero": 1,
      "texto": "texto curto da p√°gina",
      "ilustracao": "descri√ß√£o detalhada para DALL-E"
    }
  ]
}`
                    }],
                    temperature: 0.8
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            const content = data.choices[0].message.content;
            
            // Extrair JSON
            let jsonMatch = content.match(/```json\n([\s\S]*?)\n```/) || content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[1] || jsonMatch[0]);
            }
            throw new Error('Formato de resposta inv√°lido');
        }

        // Gerar imagem com DALL-E
        async function generateImageFromPrompt(prompt, apiKey) {
            const response = await fetch('https://api.openai.com/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'dall-e-3',
                    prompt: prompt,
                    n: 1,
                    size: '1024x1024',
                    quality: 'standard'
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }

            return data.data[0].url;
        }

        // Adicionar texto na imagem automaticamente
        async function addTextToImage(imageUrl, text) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    
                    // Desenhar imagem
                    tempCtx.drawImage(img, 0, 0);
                    
                    // Configurar texto
                    const fontSize = Math.floor(img.height / 20); // Tamanho proporcional
                    tempCtx.font = `bold ${fontSize}px Arial`;
                    tempCtx.textAlign = 'center';
                    tempCtx.textBaseline = 'bottom';
                    
                    // Adicionar texto na parte inferior com fundo semi-transparente
                    const textY = img.height - fontSize;
                    const textX = img.width / 2;
                    
                    // Fundo do texto
                    tempCtx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                    const lines = wrapText(tempCtx, text, img.width * 0.9);
                    const lineHeight = fontSize * 1.2;
                    const boxHeight = lines.length * lineHeight + 20;
                    tempCtx.fillRect(0, img.height - boxHeight, img.width, boxHeight);
                    
                    // Desenhar texto linha por linha
                    lines.forEach((line, index) => {
                        const y = img.height - boxHeight + 20 + (index * lineHeight) + fontSize;
                        
                        // Contorno preto
                        tempCtx.strokeStyle = '#000000';
                        tempCtx.lineWidth = 4;
                        tempCtx.strokeText(line, textX, y);
                        
                        // Texto branco
                        tempCtx.fillStyle = '#ffffff';
                        tempCtx.fillText(line, textX, y);
                    });
                    
                    resolve(tempCanvas.toDataURL('image/png'));
                };
                
                img.onerror = () => reject(new Error('Falha ao carregar imagem'));
                img.src = imageUrl;
            });
        }

        // Quebrar texto em linhas
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            words.forEach(word => {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            });
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            return lines;
        }

        // Compilar PDF
        async function compilePDFFromPages(pages, title, author) {
            return new Promise((resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    // Capa
                    pdf.setFontSize(28);
                    pdf.text(title, 105, 100, { align: 'center' });
                    pdf.setFontSize(16);
                    pdf.text(`Por ${author}`, 105, 120, { align: 'center' });

                    // Adicionar p√°ginas
                    pages.forEach((page, index) => {
                        pdf.addPage();
                        
                        // Adicionar imagem centralizada
                        const imgWidth = 190;
                        const imgHeight = 190;
                        pdf.addImage(page.image, 'PNG', 10, 20, imgWidth, imgHeight);

                        // N√∫mero da p√°gina
                        pdf.setFontSize(10);
                        pdf.text(`${index + 1}`, 105, 287, { align: 'center' });
                    });

                    resolve(pdf.output('blob'));
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Download PDF
        function downloadPDF(blob, title) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Mostrar mensagem de sucesso
        function showSuccessMessage(title, numPages) {
            const resultDiv = document.getElementById('mainResult');
            resultDiv.innerHTML = `
                <div class="result-box" style="text-align: center; padding: 40px;">
                    <h2 style="color: #28a745; font-size: 2.5em; margin-bottom: 20px;">üéâ Sucesso!</h2>
                    <p style="font-size: 1.3em; margin-bottom: 10px;"><strong>${title}</strong></p>
                    <p style="font-size: 1.1em; color: #666;">E-book criado com ${numPages} p√°ginas</p>
                    <p style="margin-top: 30px; font-size: 1em;">O PDF foi baixado automaticamente!</p>
                    <button class="btn" onclick="location.reload()" style="margin-top: 20px;">
                        üîÑ Criar Novo E-book
                    </button>
                </div>
            `;
        }

        // Salvar/Carregar E-books
        function saveEbooks() {
            // N√£o salvar blobs no localStorage (muito grande)
            const ebooksToSave = generatedEbooks.map(eb => ({
                id: eb.id,
                title: eb.title,
                theme: eb.theme,
                pages: eb.pages,
                createdAt: eb.createdAt
            }));
            localStorage.setItem('generated_ebooks', JSON.stringify(ebooksToSave));
        }

        function loadEbooks() {
            const saved = localStorage.getItem('generated_ebooks');
            if (saved) {
                generatedEbooks = JSON.parse(saved);
            }
        }

        function displayEbooks() {
            const listDiv = document.getElementById('ebooksList');
            
            if (generatedEbooks.length === 0) {
                listDiv.innerHTML = `
                    <div class="alert alert-warning" style="grid-column: 1/-1;">
                        Nenhum e-book criado ainda. V√° para a primeira aba e crie seu primeiro e-book!
                    </div>
                `;
                return;
            }

            let html = '';
            generatedEbooks.forEach(ebook => {
                const date = new Date(ebook.createdAt).toLocaleDateString('pt-BR');
                html += `
                    <div class="page-item">
                        <div style="padding: 15px;">
                            <h3 style="color: #667eea; margin-bottom: 10px;">${ebook.title}</h3>
                            <p style="color: #666; margin: 5px 0;"><strong>Tema:</strong> ${ebook.theme}</p>
                            <p style="color: #666; margin: 5px 0;"><strong>P√°ginas:</strong> ${ebook.pages}</p>
                            <p style="color: #666; margin: 5px 0;"><strong>Criado:</strong> ${date}</p>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteEbook(${ebook.id})">
                            üóëÔ∏è Excluir
                        </button>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        function deleteEbook(id) {
            if (confirm('Tem certeza que deseja excluir este e-book?')) {
                generatedEbooks = generatedEbooks.filter(eb => eb.id !== id);
                saveEbooks();
                displayEbooks();
            }
        }

        // Canvas Editor (mantido para edi√ß√£o manual)
        function initCanvas() {
            canvas = document.getElementById('imageCanvas');
            ctx = canvas.getContext('2d');
            
            canvas.addEventListener('click', function(e) {
                if (isTextMode) {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    drawText(x, y);
                }
            });
        }

        function loadImageToCanvas(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        currentImage = img;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function addTextToCanvas() {
            const text = document.getElementById('canvasText').value;
            if (!text) {
                alert('‚ö†Ô∏è Digite um texto primeiro!');
                return;
            }
            if (!currentImage) {
                alert('‚ö†Ô∏è Carregue uma imagem primeiro!');
                return;
            }
            
            isTextMode = true;
            currentTextSettings = {
                text: text,
                fontSize: document.getElementById('fontSize').value,
                fontFamily: document.getElementById('fontFamily').value,
                textColor: document.getElementById('textColor').value,
                strokeColor: document.getElementById('strokeColor').value,
                strokeWidth: document.getElementById('strokeWidth').value
            };
            
            alert('‚úÖ Modo de texto ativado! Clique na posi√ß√£o desejada no canvas.');
        }

        function drawText(x, y) {
            const settings = currentTextSettings;
            ctx.font = `${settings.fontSize}px ${settings.fontFamily}`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            if (settings.strokeWidth > 0) {
                ctx.strokeStyle = settings.strokeColor;
                ctx.lineWidth = settings.strokeWidth;
                ctx.strokeText(settings.text, x, y);
            }
            
            ctx.fillStyle = settings.textColor;
            ctx.fillText(settings.text, x, y);
            
            isTextMode = false;
        }

        function clearCanvas() {
            if (currentImage) {
                canvas.width = currentImage.width;
                canvas.height = currentImage.height;
                ctx.drawImage(currentImage, 0, 0);
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
    </script>
</body>
</html>
